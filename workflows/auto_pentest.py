"""
Auto API Pentest Workflow
- Automatic vulnerability detection and testing
- OWASP Top 10 API mapping
- Specialized attack workflows
"""

import json
import logging
from typing import Dict, Any
from modules import (
    APIDiscoveryAnalyzer,
    AuthenticationAttackAnalyzer,
    AuthorizationAttackAnalyzer,
    InjectionAttackAnalyzer,
    BusinessLogicAttackAnalyzer,
    MassAssignmentAnalyzer,
    RateLimitingDoSAnalyzer,
    GraphQLAttackAnalyzer,
    FileUploadDeserializationAnalyzer,
    SecretsTokenAbuseAnalyzer,
    OWASP_TOP_10_API
)

logger = logging.getLogger(__name__)

class AutoPentest:
    """Automated API pentesting workflow"""
    
    def __init__(self, base_url: str, token: str = None):
        self.base_url = base_url
        self.token = token
        self.results = {}
        
    def run_full_scan(self) -> Dict[str, Any]:
        """Run complete API penetration test"""
        logger.info(f"[*] Starting full API pentest on {self.base_url}...")
        
        results = {
            'base_url': self.base_url,
            'timestamp': __import__('time').strftime('%Y-%m-%d %H:%M:%S'),
            'tests': {}
        }
        
        # 1. Discovery
        logger.info("[*] Phase 1: API Discovery & Enumeration")
        discovery = APIDiscoveryAnalyzer(self.base_url)
        results['tests']['discovery'] = discovery.analyze()
        
        # 2. Authentication
        logger.info("[*] Phase 2: Authentication Attacks")
        auth = AuthenticationAttackAnalyzer(self.base_url, self.token)
        results['tests']['authentication'] = auth.analyze()
        
        # 3. Authorization
        logger.info("[*] Phase 3: Authorization Attacks")
        authz = AuthorizationAttackAnalyzer(self.base_url, self.token)
        results['tests']['authorization'] = authz.analyze()
        
        # 4. Injection
        logger.info("[*] Phase 4: Injection Attacks")
        injection = InjectionAttackAnalyzer(self.base_url, self.token)
        results['tests']['injection'] = injection.analyze()
        
        # 5. Business Logic
        logger.info("[*] Phase 5: Business Logic Attacks")
        biz_logic = BusinessLogicAttackAnalyzer(self.base_url, self.token)
        results['tests']['business_logic'] = biz_logic.analyze()
        
        # 6. Mass Assignment
        logger.info("[*] Phase 6: Mass Assignment")
        mass_assign = MassAssignmentAnalyzer(self.base_url, self.token)
        results['tests']['mass_assignment'] = mass_assign.analyze()
        
        # 7. Rate Limiting
        logger.info("[*] Phase 7: Rate Limiting & DoS")
        rate_limit = RateLimitingDoSAnalyzer(self.base_url, self.token)
        results['tests']['rate_limiting'] = rate_limit.analyze()
        
        # 8. GraphQL (if available)
        logger.info("[*] Phase 8: GraphQL Attacks")
        graphql = GraphQLAttackAnalyzer(self.base_url)
        results['tests']['graphql'] = graphql.analyze()
        
        # 9. File Upload
        logger.info("[*] Phase 9: File Upload & Deserialization")
        file_upload = FileUploadDeserializationAnalyzer(self.base_url, self.token)
        results['tests']['file_upload'] = file_upload.analyze()
        
        # 10. Secrets
        logger.info("[*] Phase 10: Secrets & Token Abuse")
        secrets = SecretsTokenAbuseAnalyzer(self.base_url, self.token)
        results['tests']['secrets'] = secrets.analyze()
        
        self.results = results
        return results
    
    def generate_report(self) -> Dict[str, Any]:
        """Generate vulnerability report with OWASP mapping"""
        
        report = {
            'summary': self._generate_summary(),
            'vulnerabilities': self._categorize_vulnerabilities(),
            'owasp_mapping': self._map_to_owasp(),
            'recommendations': self._generate_recommendations()
        }
        
        return report
    
    def _generate_summary(self) -> Dict[str, Any]:
        """Generate executive summary"""
        
        vulnerabilities = []
        for test_type, test_results in self.results.get('tests', {}).items():
            if isinstance(test_results, dict) and test_results.get('vulnerable'):
                vulnerabilities.append(test_type)
        
        return {
            'total_vulnerabilities': len(vulnerabilities),
            'vulnerable_categories': vulnerabilities,
            'risk_level': self._calculate_risk_level(len(vulnerabilities))
        }
    
    def _categorize_vulnerabilities(self) -> Dict[str, list]:
        """Categorize found vulnerabilities"""
        
        critical = []
        high = []
        medium = []
        
        vuln_mapping = {
            'injection': 'critical',
            'authentication': 'critical',
            'authorization': 'high',
            'business_logic': 'high',
            'mass_assignment': 'high',
            'rate_limiting': 'medium',
            'graphql': 'medium',
            'file_upload': 'critical',
            'secrets': 'critical'
        }
        
        for test_type, test_results in self.results.get('tests', {}).items():
            if isinstance(test_results, dict) and test_results.get('vulnerable'):
                severity = vuln_mapping.get(test_type, 'medium')
                if severity == 'critical':
                    critical.append(test_type)
                elif severity == 'high':
                    high.append(test_type)
                else:
                    medium.append(test_type)
        
        return {
            'critical': critical,
            'high': high,
            'medium': medium
        }
    
    def _map_to_owasp(self) -> Dict[int, Dict]:
        """Map vulnerabilities to OWASP Top 10 API"""
        
        mapping = {
            'authorization': [1, 5],  # BOLA, Function Level Auth
            'authentication': [2],     # Broken Auth
            'injection': [8],          # Injection
            'business_logic': [7],     # Security Misconfiguration
            'mass_assignment': [6],    # Mass Assignment
            'rate_limiting': [4],      # Lack of Rate Limiting
            'secrets': [9, 10],        # Asset Management, Logging
            'file_upload': [7],        # Security Misconfiguration
            'graphql': [1, 3]          # BOLA, Excessive Data
        }
        
        result = {}
        for i in range(1, 11):
            result[i] = OWASP_TOP_10_API[i]
        
        return result
    
    def _calculate_risk_level(self, vuln_count: int) -> str:
        """Calculate overall risk level"""
        
        if vuln_count >= 7:
            return 'CRITICAL'
        elif vuln_count >= 5:
            return 'HIGH'
        elif vuln_count >= 2:
            return 'MEDIUM'
        else:
            return 'LOW'
    
    def _generate_recommendations(self) -> Dict[str, list]:
        """Generate remediation recommendations"""
        
        recommendations = {
            'authentication': [
                'Implement strong JWT validation',
                'Enforce secure token storage',
                'Use short-lived tokens with refresh tokens'
            ],
            'authorization': [
                'Implement proper RBAC',
                'Use object-level authorization checks',
                'Validate user permissions on every request'
            ],
            'injection': [
                'Use parameterized queries',
                'Validate and sanitize all inputs',
                'Use ORM frameworks'
            ],
            'rate_limiting': [
                'Implement rate limiting on all endpoints',
                'Use per-user rate limits',
                'Monitor for abuse patterns'
            ],
            'mass_assignment': [
                'Use allowlists for parameters',
                'Avoid mass assignment',
                'Explicitly define updatable fields'
            ]
        }
        
        return recommendations
