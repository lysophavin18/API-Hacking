#!/usr/bin/env python3
"""
API Penetration Testing Orchestrator
Complete framework for automated API security testing
"""

import argparse
import json
import logging
import sys
from pathlib import Path
from workflows.auto_pentest import AutoPentest
from utils.request_builder import RequestBuilder, PayloadGenerator, ResultParser

# Setup logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

class APIPentestOrchestrator:
    """Main orchestrator for API penetration testing"""
    
    def __init__(self, base_url: str, token: str = None, output_dir: str = 'results'):
        self.base_url = base_url
        self.token = token
        self.output_dir = Path(output_dir)
        self.output_dir.mkdir(exist_ok=True)
        
    def run_pentest(self) -> Dict:
        """Run complete API penetration test"""
        logger.info(f"[*] Starting API penetration test on {self.base_url}")
        
        pentest = AutoPentest(self.base_url, self.token)
        results = pentest.run_full_scan()
        report = pentest.generate_report()
        
        # Save results
        self._save_results(results, report)
        
        return report
    
    def _save_results(self, results: Dict, report: Dict):
        """Save test results to files"""
        
        # Save full results
        results_file = self.output_dir / 'pentest_results.json'
        with open(results_file, 'w') as f:
            json.dump(results, f, indent=2, default=str)
        logger.info(f"[+] Results saved to {results_file}")
        
        # Save report
        report_file = self.output_dir / 'pentest_report.json'
        with open(report_file, 'w') as f:
            json.dump(report, f, indent=2, default=str)
        logger.info(f"[+] Report saved to {report_file}")
        
        # Save summary
        summary = self._generate_summary_report(report)
        summary_file = self.output_dir / 'pentest_summary.md'
        with open(summary_file, 'w') as f:
            f.write(summary)
        logger.info(f"[+] Summary saved to {summary_file}")
    
    def _generate_summary_report(self, report: Dict) -> str:
        """Generate markdown summary report"""
        
        summary = f"""# API Penetration Test Report

## Executive Summary

**Target**: {self.base_url}
**Risk Level**: {report['summary']['risk_level']}
**Total Vulnerabilities**: {report['summary']['total_vulnerabilities']}

## Vulnerabilities Found

### Critical
{self._format_list(report['vulnerabilities']['critical'])}

### High
{self._format_list(report['vulnerabilities']['high'])}

### Medium
{self._format_list(report['vulnerabilities']['medium'])}

## OWASP Top 10 API Mapping

"""
        for i, vuln in report['owasp_mapping'].items():
            if str(i) in str(report['vulnerabilities']):
                summary += f"- **API{i}**: {vuln}\n"
        
        summary += "\n## Recommendations\n"
        for category, recs in report['recommendations'].items():
            summary += f"\n### {category.replace('_', ' ').title()}\n"
            for rec in recs:
                summary += f"- {rec}\n"
        
        return summary
    
    def _format_list(self, items: list) -> str:
        """Format list as markdown"""
        if not items:
            return "- None\n"
        return "\n".join([f"- {item}" for item in items])

def main():
    parser = argparse.ArgumentParser(
        description='API Penetration Testing Framework',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog='''
Examples:
  %(prog)s http://api.target.com
  %(prog)s http://api.target.com --token YOUR_TOKEN
  %(prog)s http://api.target.com -o ./custom_results
        '''
    )
    
    parser.add_argument('url', help='Target API URL')
    parser.add_argument('--token', '-t', help='Authentication token')
    parser.add_argument('--output', '-o', default='results', help='Output directory')
    parser.add_argument('--verbose', '-v', action='store_true', help='Verbose output')
    
    args = parser.parse_args()
    
    if args.verbose:
        logging.getLogger().setLevel(logging.DEBUG)
    
    try:
        orchestrator = APIPentestOrchestrator(args.url, args.token, args.output)
        report = orchestrator.run_pentest()
        
        logger.info("\n" + "="*50)
        logger.info("PENETRATION TEST COMPLETE")
        logger.info("="*50)
        logger.info(f"Risk Level: {report['summary']['risk_level']}")
        logger.info(f"Vulnerabilities Found: {report['summary']['total_vulnerabilities']}")
        logger.info(f"Results saved to: {orchestrator.output_dir}")
        
    except KeyboardInterrupt:
        logger.warning("[!] Test interrupted by user")
        sys.exit(1)
    except Exception as e:
        logger.error(f"[!] Error: {e}")
        sys.exit(1)

if __name__ == '__main__':
    main()
